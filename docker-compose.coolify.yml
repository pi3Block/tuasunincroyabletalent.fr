# ===========================================
# Docker Compose for Coolify - Production Ready
# ===========================================
# Single self-contained file for Coolify deployment
# GPU NVIDIA required for worker service
#
# SHARED INFRASTRUCTURE (2026-02-11):
# - PostgreSQL: uses augmenter-db (pgvector/pgvector:pg16)
#   Database: voicejury, User: voicejury
# - Redis: uses augmenter-redis (redis:7-alpine)
#   DB index 2 (broker), DB index 7 (results)
# - Both accessed via coolify network DNS
#
# BUILD OPTIMIZATION:
# - .dockerignore in each service dir (reduces context by ~200MB)
# - Worker uses gpu-worker-base shared image (~2min vs ~15min)
# - BuildKit cache mounts for npm/pip

services:
  # ============================================
  # Frontend - React + Vite + Nginx
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        - VITE_API_URL=${VITE_API_URL:-https://api.tuasunincroyabletalent.fr}
        - CACHE_BUST=20260119
    expose:
      - "80"
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - voicejury-network
      - coolify
    labels:
      - traefik.enable=true
      - traefik.http.routers.voicejury-frontend.rule=Host(`tuasunincroyabletalent.fr`)
      - traefik.http.routers.voicejury-frontend.entrypoints=https
      - traefik.http.routers.voicejury-frontend.tls.certresolver=letsencrypt
      - traefik.http.services.voicejury-frontend.loadbalancer.server.port=80

  # ============================================
  # Backend API - FastAPI + Uvicorn
  # ============================================
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    expose:
      - "8080"
    volumes:
      - audio-data:/app/audio_files
    environment:
      - DATABASE_URL=postgresql://voicejury:${POSTGRES_PASSWORD:-voicejury_secret}@augmenter-db-d80w4sgsw4sk4c00cw80ggw8:5432/voicejury
      - REDIS_URL=redis://:${AUGMENTER_REDIS_PASSWORD}@augmenter-redis-d80w4sgsw4sk4c00cw80ggw8:6379/2
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11435}
      - SPOTIFY_CLIENT_ID=${SPOTIFY_CLIENT_ID}
      - SPOTIFY_CLIENT_SECRET=${SPOTIFY_CLIENT_SECRET}
      - GENIUS_API_TOKEN=${GENIUS_API_TOKEN:-}
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=false
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    networks:
      - voicejury-network
      - coolify
    labels:
      - traefik.enable=true
      - traefik.http.routers.voicejury-api.rule=Host(`api.tuasunincroyabletalent.fr`)
      - traefik.http.routers.voicejury-api.entrypoints=https
      - traefik.http.routers.voicejury-api.tls.certresolver=letsencrypt
      - traefik.http.services.voicejury-api.loadbalancer.server.port=8080
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Worker Heavy - GPU (Demucs, CREPE, Whisper fallback)
  # ============================================
  # Dedicated worker on RTX 3080 (10 Go, GPU-bdb1f5e4)
  # Whisper via shared-whisper HTTP, Demucs + CREPE local
  # Ollama via light instance on host (:11435, qwen3:4b)
  # Uses gpu-worker-base shared image for fast builds (~2min vs ~15min)
  worker-heavy:
    build:
      context: ./worker
      dockerfile: Dockerfile.optimized
    command: ["celery", "-A", "tasks.celery_app", "worker", "--loglevel=info", "--pool=solo", "-Q", "gpu-heavy,gpu", "-n", "heavy@%h"]
    volumes:
      - audio-data:/app/audio_files
      - model-cache:/root/.cache
    environment:
      - REDIS_URL=redis://:${AUGMENTER_REDIS_PASSWORD}@augmenter-redis-d80w4sgsw4sk4c00cw80ggw8:6379/2
      - DATABASE_URL=postgresql://voicejury:${POSTGRES_PASSWORD:-voicejury_secret}@augmenter-db-d80w4sgsw4sk4c00cw80ggw8:5432/voicejury
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11435}
      - SHARED_WHISPER_URL=${SHARED_WHISPER_URL:-http://shared-whisper:9000}
      - WHISPER_MODEL=${WHISPER_MODEL:-turbo}
      - CUDA_VISIBLE_DEVICES=0
    extra_hosts:
      - "host.docker.internal:host-gateway"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['GPU-bdb1f5e4-d03c-b5c1-bb9c-59f3d08d161d']
              capabilities: [gpu]
        limits:
          memory: 6G
    restart: unless-stopped
    networks:
      - voicejury-network
      - coolify

  # ============================================
  # Worker Pool - GPU secondaire (optionnel)
  # ============================================
  # Second GPU worker for light tasks (CREPE pitch analysis)
  # Activate with COMPOSE_PROFILES=multi-gpu
  # For single GPU setup: don't set COMPOSE_PROFILES
  worker-pool:
    build:
      context: ./worker
      dockerfile: Dockerfile.optimized
    command: ["celery", "-A", "tasks.celery_app", "worker", "--loglevel=info", "--pool=solo", "-Q", "gpu", "-n", "pool@%h"]
    volumes:
      - audio-data:/app/audio_files
      - model-cache:/root/.cache
    environment:
      - REDIS_URL=redis://:${AUGMENTER_REDIS_PASSWORD}@augmenter-redis-d80w4sgsw4sk4c00cw80ggw8:6379/2
      - DATABASE_URL=postgresql://voicejury:${POSTGRES_PASSWORD:-voicejury_secret}@augmenter-db-d80w4sgsw4sk4c00cw80ggw8:5432/voicejury
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11435}
      - SHARED_WHISPER_URL=${SHARED_WHISPER_URL:-http://shared-whisper:9000}
      - WHISPER_MODEL=${WHISPER_MODEL:-turbo}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['GPU-bdb1f5e4-d03c-b5c1-bb9c-59f3d08d161d']
              capabilities: [gpu]
    profiles:
      - multi-gpu
    restart: unless-stopped
    networks:
      - voicejury-network
      - coolify

# ============================================
# Volumes (Persistent Data)
# ============================================
volumes:
  audio-data:
  model-cache:

# ============================================
# Networks
# ============================================
networks:
  voicejury-network:
    driver: bridge
  coolify:
    external: true
